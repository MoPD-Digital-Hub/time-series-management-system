{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'base/common/head.html' %}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    
    <style>
        :root { --mopd-blue: #3f8cff; --mopd-bg: #f8fafd; }
        body { background-color: var(--mopd-bg); font-family: 'Inter', sans-serif; }
        
        .card { border-radius: 20px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.04); }
        .form-label { font-weight: 600; font-size: 0.85rem; color: #4b5563; margin-bottom: 0.5rem; }
        
        .form-control { 
            border: 1px solid #e5e7eb; border-radius: 12px; padding: 0.75rem 1rem; 
            background: #fcfdfe; transition: 0.2s;
        }
        .form-control:focus { border-color: var(--mopd-blue); box-shadow: 0 0 0 4px rgba(63, 140, 255, 0.1); }

        /* Custom Sectioning */
        .section-tag { font-size: 0.7rem; font-weight: 800; text-transform: uppercase; color: var(--mopd-blue); letter-spacing: 1px; }
        
        /* Choices.js Customization */
        .choices__inner { border-radius: 12px !important; border: 1px solid #e5e7eb !important; background: #fcfdfe !important; }
        .choices__pill { background: var(--mopd-blue) !important; border-radius: 6px !important; border: none !important; }
        
        .btn-save { padding: 12px 30px; border-radius: 12px; font-weight: 600; }
        .btn-cancel { padding: 12px 30px; border-radius: 12px; font-weight: 600; color: #64748b; }
    </style>
</head>

<body>
{% include 'data_management/common/nav.html' %}
{% include 'data_management/common/header.html' %}

<div class="pc-container">
    <div class="pc-content">
        
        <div class="row justify-content-center">
            <div class="col-lg-8">
                
                <div class="mb-4">
                    <a href="{% url 'user_management_dashboard' %}" class="text-decoration-none text-muted small fw-bold">
                        <i class="ti ti-arrow-left me-1"></i> Back to User List
                    </a>
                </div>

                <div class="card shadow-sm">
                    <div class="card-body p-lg-5">
                        <div class="text-center mb-5">
                            <div class="d-inline-flex align-items-center justify-content-center bg-soft-primary text-primary rounded-circle mb-3" style="width: 60px; height: 60px;">
                                <i class="ti ti-user-cog fs-1"></i>
                            </div>
                            <h3 class="fw-bold">{{ title }}</h3>
                            <p class="text-muted">Fill in the profile details and assign data access levels.</p>
                        </div>

                        <form method="POST">
                            {% csrf_token %}

                            <div class="section-tag mb-3">Personal Information</div>
                            <div class="row g-3 mb-4">
                                <div class="col-md-6">
                                    <label class="form-label">First Name</label>
                                    <input type="text" name="first_name" class="form-control" value="{{ instance.first_name|default:'' }}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" name="last_name" class="form-control" value="{{ instance.last_name|default:'' }}" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Email Address (Login Username)</label>
                                    <input type="email" name="email" class="form-control" value="{{ instance.email|default:'' }}" required>
                                </div>
                            </div>

                            <div class="section-tag mb-3">Permissions & Categories</div>
                            <div class="mb-4">
                                <label class="form-label">Assigned Categories</label>
                                <select name="categories" id="categorySelect" multiple>
                                    {% for topic in all_topics %}
                                        <optgroup label="{{ topic.title_ENG }}">
                                            {% for cat in topic.categories.all %}
                                                <option value="{{ cat.id }}" {% if cat.id in assigned_cat_ids %}selected{% endif %}>
                                                    {{ cat.name_ENG }}
                                                </option>
                                            {% endfor %}
                                        </optgroup>
                                    {% endfor %}
                                </select>
                                <div class="alert alert-light border-0 small mt-2 py-2 px-3">
                                    <i class="ti ti-bulb text-warning me-2"></i>
                                    {% if request.user.is_superuser %}
                                        Assigning categories here will make this user a <strong>Category Manager</strong> for those sectors.
                                    {% else %}
                                        This user will only be able to import data for the categories you select.
                                    {% endif %}
                                </div>
                            </div>

                            <hr class="my-5 opacity-50">

                            <div class="d-flex align-items-center justify-content-between">
                                <a href="{% url 'user_management_dashboard' %}" class="btn btn-cancel">Discard Changes</a>
                                <button type="submit" class="btn btn-primary btn-save shadow-sm">
                                    <i class="ti ti-device-floppy me-2"></i> Save User Profile
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

{% include 'data_management/common/footer.html' %}
{% include 'data_management/common/js.html' %}

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const element = document.getElementById('categorySelect');
        if (element) {
            new Choices(element, {
                removeItemButton: true,
                placeholder: true,
                placeholderValue: 'Click to select categories...',
                itemSelectText: '',
                shouldSort: false,
            });
        }
    });
</script>
</body>
</html>