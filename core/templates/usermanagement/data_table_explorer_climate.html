{% load static %}

<!doctype html>

{% include 'base/common/head.html' %}
<style>
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 12px;
    }

    .dropdown-panel {
        width: min(320px, 92vw);
        max-height: 50vh;
        overflow: auto;
    }

    .dropdown-panel label span {
        white-space: normal;
        word-break: break-word;
    }

    /* Vertical table header */
    th.vhead {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        white-space: nowrap;
        vertical-align: bottom;
        text-align: left;
        font-size: 0.95em;
        padding: 0.5rem 0.25rem;
        height: 120px;
    }

    #explorer-table {
        border-collapse: collapse;
        width: 100%;
        /* removed flex: 1 1 auto to avoid stretching rows when there are few rows */
    }

    #explorer-table th,
    #explorer-table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
    }

    #explorer-table th {
        background-color: #f5f5f5;
    }

    /* Sidebar styles */
    #sidebar-container {
        background: #fefefe;
        border-color: #e5e7eb;
        display: flex;
        flex-direction: column;
        height: 600px;
    }

    .sidebar-button {
        width: 100%;
        text-align: left;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        padding: 0.55rem 0.75rem;
        background: #fff;
        transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
        display: flex;
        flex-direction: column;
        gap: 0.15rem;
    }

    .sidebar-button:hover {
        border-color: #3b82f6;
        box-shadow: 0 3px 10px rgba(59, 130, 246, 0.15);
    }

    .sidebar-button.active {
        border-color: #2563eb;
        background: linear-gradient(135deg, rgba(37, 99, 235, 0.08), rgba(59, 130, 246, 0.08));
    }

    .sidebar-button .sidebar-label {
        font-weight: 600;
        font-size: 0.9rem;
        color: #111827;
    }

    .sidebar-button .sidebar-sub {
        font-size: 0.75rem;
        color: #6b7280;
    }

    #sidebar-loading .spinner {
        width: 22px;
        height: 22px;
        border: 3px solid rgba(59, 130, 246, 0.2);
        border-top-color: #3b82f6;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    #side-pagination {
        flex: 1 1 auto;
        overflow-y: auto;
    }

    #sidebar-nav {
        padding-top: 0.35rem;
        margin-top: 0.35rem;
        border-top: 1px solid #e5e7eb;
    }

    #sidebar-nav button {
        min-width: 0;
        font-size: 0.8rem;
        padding-block: 0.35rem;
    }

    #table-wrapper {
        display: block;
        /* don't force equal-height flex layout */
        /* allow table to size to content; limit max height so it doesn't grow indefinitely */
        max-height: 600px;
        overflow: auto;
    }

    #explorer-table {
        border-collapse: collapse;
        width: 100%;
        /* removed flex: 1 1 auto to avoid stretching rows when there are few rows */
    }
</style>

<body>
    {% include "base/common/climate_sidebar.html" %}
         {% include 'base/common/header.html' %}

    <div class="pc-container">
        <div class="pc-content">
            <div class="card mb-4">
                <div class="card-body">
                    <div class="flex items-center justify-between mb-4">
                        <h5 class="mb-0 font-bold text-lg">Data Explorer</h5>
                        <div class="flex items-center gap-2">
                            <button id="clear-all"
                                class="px-3 py-1 rounded border border-theme-border text-gray-700 hover:bg-gray-50 text-sm">Clear</button>
                            <button id="apply-selection" class="btn btn-primary btn-sm hidden">Apply</button>
                        </div>
                    </div>


                    <div class="filter-grid mb-2">
                        <div class="relative">
                            <button type="button" id="dd-category-btn"
                                class="w-full justify-between px-3 py-2 rounded border border-theme-border bg-white shadow-sm hover:bg-gray-50 inline-flex items-center gap-2">
                                <i class="fas fa-folder text-warning-500"></i><span>Categories</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div id="dd-category"
                                class="hidden absolute z-10 mt-2 dropdown-panel bg-white border border-theme-border rounded shadow-lg">
                                <div class="p-2 border-b">
                                    <input id="search-category" type="text" placeholder="Search categories..."
                                        class="w-full px-2 py-2 text-sm border rounded" />
                                </div>
                                <div class="p-2 flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Select All</span>
                                    <input type="checkbox" id="category-select-all" class="form-check-input" />
                                </div>
                                <div id="category-list" class="p-2 space-y-1">
                                    {% for cat in categories %}
                                    <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-gray-50">
                                        <input type="checkbox" class="cat-checkbox" data-id="{{ cat.id }}"
                                            data-title="{{ cat.name_ENG }}">
                                        <span class="whitespace-normal break-words">{{ cat.name_ENG }}</span>
                                    </label>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>

                        <div class="relative">
                            <button type="button" id="dd-ind-btn"
                                class="w-full justify-between px-3 py-2 rounded border border-theme-border bg-white shadow-sm hover:bg-gray-50 inline-flex items-center gap-2">
                                <i class="fas fa-chart-line text-success-500"></i><span>Indicators</span>
                                <i class="fas fa-chevron-down text-xs"></i>
                            </button>
                            <div id="dd-ind"
                                class="hidden absolute z-10 mt-2 dropdown-panel bg-white border border-theme-border rounded shadow-lg">
                                <div class="p-2 border-b">
                                    <input id="search-ind" type="text" placeholder="Search indicators..."
                                        class="w-full px-2 py-2 text-sm border rounded" />
                                </div>
                                <div class="p-2 flex items-center justify-between">
                                    <span class="text-xs text-gray-500">Select All</span>
                                    <input type="checkbox" id="ind-select-all" class="form-check-input" />
                                </div>
                                <div id="ind-list" class="p-2 space-y-1">
                                    {% for cat in categories %}
                                    {% for ind in cat.indicators.all %}
                                    <label class="flex items-center gap-2 px-2 py-1 rounded hover:bg-gray-50"
                                        data-cat="{{ cat.id }}">
                                        <input type="checkbox" class="ind-checkbox" data-id="{{ ind.id }}"
                                            data-cat="{{ cat.id }}" data-title="{{ ind.title_ENG }}">
                                        <span class="whitespace-normal break-words">{{ ind.title_ENG }}</span>
                                    </label>
                                    {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500">Tip: use the dropdowns to filter; selections cascade and table
                        updates on change.</div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <div class="flex items-center gap-3 mb-3">
                        <button class="btn btn-outline-primary btn-sm data-mode" data-mode="annual">Yearly</button>
                        <button class="btn btn-outline-primary btn-sm data-mode"
                            data-mode="quarterly">Quarterly</button>
                        <button class="btn btn-outline-primary btn-sm data-mode" data-mode="monthly">Monthly</button>
                        <button class="btn btn-outline-primary btn-sm data-mode" data-mode="weekly">Weekly</button>
                        <button class="btn btn-outline-primary btn-sm data-mode" data-mode="daily">Daily</button>
                    </div>
                    <div class="flex gap-4">
                        <!-- SIDEBAR (year/quarter/month pagination) -->
                        <div id="sidebar-container" class="w-64 bg-white border rounded-lg h-[600px] p-3 hidden">
                            <div id="side-pagination" class="space-y-2 h-full overflow-y-auto pr-1"></div>
                            <!-- LOADING SPINNER -->
                            <div id="sidebar-loading" class="py-4 text-center hidden">
                                <div class="spinner mx-auto"></div>
                            </div>
                            <div id="sidebar-nav" class="flex items-center gap-2 mt-3 hidden">
                                <button id="sidebar-prev-btn" class="btn btn-outline-primary btn-sm flex-1"
                                    disabled>Previous</button>
                                <button id="sidebar-next-btn" class="btn btn-outline-primary btn-sm flex-1"
                                    disabled>Next</button>
                            </div>
                        </div>

                        <div class="table-responsive flex-1" id="table-wrapper">
                            <table class="table" id="explorer-table">
                                <thead id="explorer-head" class="align-top"></thead>
                                <tbody id="explorer-body"></tbody>
                            </table>
                            <div id="pagination-container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% include 'base/common/footer.html' %}
    {% include 'base/common/js.html' %}

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="{% static 'assets/js/data_table_expo.js' %}"></script>

</body>

</html>