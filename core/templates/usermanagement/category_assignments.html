{% load static %}
<!doctype html>
{% include 'base/common/head.html' %}

<body>
    {% include 'usermanagement/common/nav.html' %}
    {% include 'usermanagement/common/header.html' %}

    <div class="pc-container">
        <div class="pc-content">
            <!-- Page Header -->
            <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 mb-6">
                <div class="flex-1 min-w-0">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100">Category Assignments</h2>
                    <p class="text-gray-600 dark:text-gray-400 mt-1">Manage category manager assignments</p>
                </div>
            </div>

            <!-- Statistics Cards -->
            <div class="flex flex-col md:flex-row gap-6 mb-6 w-full">
                <div class="card flex-1">
                    <div class="card-body flex items-center">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-link text-blue-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900" id="total-assignments">
                                {{ assignments_page.paginator.count|default:0 }}
                            </h3>
                            <p class="text-gray-600">Total Assignments</p>
                        </div>
                    </div>
                </div>
                <div class="card flex-1">
                    <div class="card-body flex items-center">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-user-shield text-green-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900" id="active-managers">
                                {{ category_managers_count|default:0 }}
                            </h3>
                            <p class="text-gray-600">Active Managers</p>
                        </div>
                    </div>
                </div>
                <div class="card flex-1">
                    <div class="card-body flex items-center">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mr-4">
                            <i class="fas fa-layer-group text-orange-600 text-xl"></i>
                        </div>
                        <div>
                            <h3 class="text-2xl font-bold text-gray-900" id="assigned-categories">
                                {{ assigned_categories_count|default:0 }}
                            </h3>
                            <p class="text-gray-600">Assigned Categories</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Assignments Table -->
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="assignments-table">
                            <thead>
                                <tr>
                                    <th>Category Manager</th>
                                    <th>Assigned Category</th>
                                    <th>Manager Details</th>
                                    <th>Category Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for assignment in assignments_page %}
                                <tr id="row-{{ assignment.id }}">
                                    <td>
                                        <div class="flex items-center">
                                            {% if assignment.manager.photo %}
                                            <img src="{{ assignment.manager.photo.url }}"
                                                alt="{{ assignment.manager.get_full_name }}"
                                                class="w-10 h-10 rounded-full mr-3">
                                            {% else %}
                                            <div
                                                class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center mr-3">
                                                <i class="fas fa-user text-gray-600"></i>
                                            </div>
                                            {% endif %}
                                            <div>
                                                <div class="font-semibold manager-name">
                                                    {{ assignment.manager.get_full_name|default:assignment.manager.username }}
                                                </div>
                                                <div class="text-sm text-gray-500 manager-email">{{ assignment.manager.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="font-semibold category-name">{{ assignment.category.name_ENG }}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="space-y-1">
                                            <div class="text-sm">
                                                <span class="font-medium">Status:</span>
                                                <span
                                                    class="badge badge-sm manager-status {% if assignment.manager.is_active %}bg-success{% else %}bg-danger{% endif %}">
                                                    {{ assignment.manager.is_active|yesno:"Active,Inactive" }}
                                                </span>
                                            </div>
                                            <div class="text-sm">
                                                <span class="font-medium">Last Login:</span>
                                                <span class="manager-last-login">
                                                    {% if assignment.manager.last_login %}
                                                    {{ assignment.manager.last_login|date:"M d, Y" }}
                                                    {% else %}
                                                    Never
                                                    {% endif %}
                                                </span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="space-y-1">
                                            <div class="text-sm">
                                                <span class="font-medium">Indicators:</span>
                                                <span class="badge bg-info badge-sm">{{ assignment.category.indicators.count }}</span>
                                            </div>
                                            <div class="text-sm">
                                                <span class="font-medium">Topic:</span>
                                                <span class="badge bg-primary-100 badge-sm text-primary-800">{{ assignment.category.topic.title_ENG|default:"No Topic" }}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-2">
                                            <button class="btn btn-sm btn-outline-primary btn-edit-assignment"
                                                data-id="{{ assignment.id }}"
                                                data-manager-id="{{ assignment.manager.id }}">
                                                <i class="fas fa-edit mr-1"></i>Edit
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger btn-delete-assignment"
                                                data-id="{{ assignment.id }}">
                                                <i class="fas fa-trash mr-1"></i>Delete
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-gray-500 py-4">No assignments found.</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Unassigned Categories -->
            <div class="card mt-6">
                <div class="card-body">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                        <h5 class="font-bold">Unassigned Categories</h5>

                        <div class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                            <!-- Topic Filter -->
                            <select id="topic-filter" class="form-select form-select-sm" style="width: 200px;">
                                <option value="">All Topics</option>
                                {% for topic in topics %}
                                <option value="{{ topic.id }}">{{ topic.title_ENG }}</option>
                                {% endfor %}
                            </select>

                            <!-- Search Filter -->
                            <div class="input-group input-group-sm" style="width: 250px;">
                                <span class="input-group-text bg-transparent border-end-0">
                                    <i class="fas fa-search text-gray-400"></i>
                                </span>
                                <input type="text" id="category-search" class="form-control border-start-0"
                                    placeholder="Search categories...">
                            </div>
                        </div>
                    </div>

                    <div id="unassigned-categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {% for category in unassigned_categories %}
                        <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800"
                            id="unassigned-{{ category.id }}">
                            <div class="flex flex-col gap-1 mb-3">
                                <div class="flex items-center justify-between">
                                    <h6 class="font-semibold text-yellow-900 dark:text-yellow-100 mb-0">{{ category.name_ENG }}</h6>
                                    <span class="badge bg-warning badge-sm">{{ category.indicators.count }} indicators</span>
                                </div>
                                <div class="text-xs text-yellow-700 dark:text-yellow-300">
                                    <i class="fas fa-folder-open mr-1"></i>{{ category.topic.title_ENG|default:"No Topic" }}
                                </div>
                            </div>
                            <button class="btn btn-sm btn-warning btn-add-assignment"
                                data-category-id="{{ category.id }}">
                                <i class="fas fa-plus mr-1"></i>Assign Manager
                            </button>
                        </div>
                        {% empty %}
                        <div class="col-span-1 text-gray-500">All categories are assigned.</div>
                        {% endfor %}
                    </div>
                </div>
            </div>

        </div>
    </div>

    {% include 'usermanagement/common/footer.html' %}

    <!-- Modal - MUST be outside pc-container to avoid z-index/overflow issues -->
    <div class="modal fade" id="assignmentModal" tabindex="-1" aria-labelledby="assignmentModalLabel" aria-hidden="true"
        style="z-index: 9999 !important;">
        <div class="modal-dialog modal-dialog-centered" style="opacity: 1 !important; visibility: visible !important;">
            <div class="modal-content" style="opacity: 1 !important; visibility: visible !important;">
                <form id="assignment-form">
                    <div class="modal-header">
                        <h5 class="modal-title" id="assignmentModalLabel">Assign Manager</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="assignment-id">
                        <input type="hidden" id="category-id">
                        <div class="mb-3">
                            <label for="manager-select" class="form-label">Category Manager</label>
                            <select id="manager-select" class="form-select" required>
                                <option value="">-- Select Manager --</option>
                                {% for manager in managers %}
                                <option value="{{ manager.id }}">{{ manager.get_full_name }} ({{ manager.email }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    {% include 'usermanagement/common/js.html' %}

    <script>
        (function () {
            'use strict';

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            // Global variables
            let assignmentModal = null;
            let assignmentModalEl = null;
            let assignmentForm = null;
            let assignmentIdInput = null;
            let categoryIdInput = null;
            let managerSelect = null;
            let csrftoken = null;

            function showModalManually() {
                if (!assignmentModalEl) {
                    console.error('assignmentModalEl is null');
                    return false;
                }

                console.log('=== showModalManually START ===');

                // FIRST: Set aria-hidden to false BEFORE anything else
                assignmentModalEl.removeAttribute('aria-hidden');
                assignmentModalEl.setAttribute('aria-hidden', 'false');
                assignmentModalEl.setAttribute('aria-modal', 'true');

                // SECOND: Add show class (CSS requires .modal.show { display: block; })
                assignmentModalEl.classList.add('show');

                // THIRD: Remove fade class
                assignmentModalEl.classList.remove('fade');

                // FOURTH: Set display (Bootstrap will handle this, but we force it)
                assignmentModalEl.style.display = 'block';

                // FIFTH: Create backdrop
                let backdrop = document.querySelector('.modal-backdrop');
                if (!backdrop) {
                    backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    backdrop.style.zIndex = '9998';  // Ensure backdrop is below modal but above everything else
                    document.body.appendChild(backdrop);
                } else {
                    backdrop.style.zIndex = '9998';
                }

                // SIXTH: Add body classes
                document.body.classList.add('modal-open');
                document.body.style.overflow = 'hidden';

                console.log('=== showModalManually END ===');
                console.log('aria-hidden:', assignmentModalEl.getAttribute('aria-hidden'));
                console.log('has show class:', assignmentModalEl.classList.contains('show'));
                console.log('display:', window.getComputedStyle(assignmentModalEl).display);

                return true;
            }

            // Function to manually hide modal
            function hideModalManually() {
                if (!assignmentModalEl) return;

                assignmentModalEl.classList.remove('show');
                assignmentModalEl.setAttribute('aria-hidden', 'true');
                assignmentModalEl.removeAttribute('aria-modal');
                assignmentModalEl.style.display = 'none';
                assignmentModalEl.classList.add('fade');

                // Remove backdrop (check both IDs)
                let backdrop = document.getElementById('modaloverlay');
                if (!backdrop) {
                    backdrop = document.querySelector('.modal-backdrop');
                }
                if (backdrop) {
                    backdrop.remove();
                }

                // Remove body classes
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }

            // Function to show modal (tries Bootstrap first, falls back to manual)
            function showModal() {
                console.log('showModal called, assignmentModal:', assignmentModal);

                // FIRST: Always set aria-hidden to false
                if (assignmentModalEl) {
                    assignmentModalEl.removeAttribute('aria-hidden');
                    assignmentModalEl.setAttribute('aria-hidden', 'false');
                }

                if (assignmentModal && typeof assignmentModal.show === 'function') {
                    try {
                        console.log('Using Bootstrap modal.show()');
                        assignmentModal.show();
                        // Double-check aria-hidden after Bootstrap show AND force visibility
                        setTimeout(() => {
                            if (assignmentModalEl.getAttribute('aria-hidden') === 'true') {
                                console.warn('Bootstrap set aria-hidden to true, fixing...');
                                assignmentModalEl.setAttribute('aria-hidden', 'false');
                            }

                            // FORCE VISIBILITY - override any CSS
                            assignmentModalEl.style.opacity = '1';
                            assignmentModalEl.style.visibility = 'visible';

                            const modalDialog = assignmentModalEl.querySelector('.modal-dialog');
                            const modalContent = assignmentModalEl.querySelector('.modal-content');
                            if (modalDialog) {
                                modalDialog.style.opacity = '1';
                                modalDialog.style.visibility = 'visible';
                            }
                            if (modalContent) {
                                modalContent.style.opacity = '1';
                                modalContent.style.visibility = 'visible';
                            }
                            console.log('FORCED visibility styles applied to modal and children');
                        }, 50);
                        return true;
                    } catch (e) {
                        console.warn('Bootstrap modal.show() failed, using manual method:', e);
                        return showModalManually();
                    }
                } else {
                    console.warn('Bootstrap modal not available, using manual method');
                    return showModalManually();
                }
            }

            // Function to hide modal
            function hideModal() {
                if (assignmentModal && typeof assignmentModal.hide === 'function') {
                    try {
                        assignmentModal.hide();
                        return true;
                    } catch (e) {
                        console.warn('Bootstrap modal.hide() failed, using manual method:', e);
                        hideModalManually();
                        return true;
                    }
                } else {
                    hideModalManually();
                    return true;
                }
            }

            // Initialize when DOM is ready
            document.addEventListener("DOMContentLoaded", function () {
                csrftoken = getCookie('csrftoken');
                if (!csrftoken) {
                    console.error('CSRF token not found');
                }

                // Get modal elements
                assignmentModalEl = document.getElementById('assignmentModal');
                assignmentForm = document.getElementById('assignment-form');
                assignmentIdInput = document.getElementById('assignment-id');
                categoryIdInput = document.getElementById('category-id');
                managerSelect = document.getElementById('manager-select');

                if (!assignmentModalEl || !assignmentForm || !assignmentIdInput || !categoryIdInput || !managerSelect) {
                    console.error('Required modal elements not found');
                    console.error('assignmentModalEl:', assignmentModalEl);
                    console.error('assignmentForm:', assignmentForm);
                    return;
                }

                // Modal should already be in body (we moved it in HTML)
                console.log('Modal parent:', assignmentModalEl.parentElement);

                // Set initial hidden state
                assignmentModalEl.style.display = 'none';
                assignmentModalEl.setAttribute('aria-hidden', 'true');
                console.log('Modal initialized and hidden');

                // Try to initialize Bootstrap modal
                if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        // Dispose any existing instance
                        const existingInstance = bootstrap.Modal.getInstance(assignmentModalEl);
                        if (existingInstance) {
                            existingInstance.dispose();
                        }

                        // Create new instance
                        assignmentModal = new bootstrap.Modal(assignmentModalEl, {
                            backdrop: true,
                            keyboard: true,
                            focus: true
                        });
                        console.log('Bootstrap modal initialized successfully');
                    } catch (e) {
                        console.warn('Bootstrap modal initialization failed, will use manual method:', e);
                        assignmentModal = null;
                    }
                } else {
                    console.warn('Bootstrap not available, will use manual modal method');
                    assignmentModal = null;
                }

                // Function to reset modal
                function resetModal() {
                    assignmentForm.reset();
                    assignmentIdInput.value = '';
                    categoryIdInput.value = '';
                    managerSelect.value = '';

                    // Remove any temporarily added manager options (from Edit modal)
                    const tempOptions = managerSelect.querySelectorAll('option[data-current="true"]');
                    tempOptions.forEach(opt => opt.remove());

                    const submitBtn = assignmentForm.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Save';
                    }
                }

                // Bootstrap modal event listeners to ensure aria-hidden is correct
                assignmentModalEl.addEventListener('show.bs.modal', function () {
                    console.log('Bootstrap show.bs.modal event fired');
                    assignmentModalEl.setAttribute('aria-hidden', 'false');
                });

                assignmentModalEl.addEventListener('shown.bs.modal', function () {
                    console.log('Bootstrap shown.bs.modal event fired');
                    // Double-check aria-hidden after modal is fully shown
                    if (assignmentModalEl.getAttribute('aria-hidden') === 'true') {
                        console.warn('aria-hidden is still true after shown event, fixing...');
                        assignmentModalEl.setAttribute('aria-hidden', 'false');
                    }
                    // Ensure backdrop has proper z-index
                    const backdrop = document.querySelector('.modal-backdrop');
                    if (backdrop) {
                        backdrop.style.zIndex = '9998';
                    }
                });

                assignmentModalEl.addEventListener('hidden.bs.modal', function () {
                    console.log('Bootstrap hidden.bs.modal event fired');
                    resetModal();
                });

                // Also handle manual close
                assignmentModalEl.addEventListener('click', function (e) {
                    if (e.target === assignmentModalEl || e.target.classList.contains('modal-backdrop')) {
                        hideModal();
                        resetModal();
                    }
                });

                // Function to open modal for adding assignment
                function openAddModal(categoryId) {
                    console.log('=== openAddModal START ===');
                    console.log('categoryId:', categoryId);
                    console.log('assignmentModalEl:', assignmentModalEl);
                    console.log('assignmentModal:', assignmentModal);

                    if (!categoryId) {
                        alert('Invalid category ID.');
                        return false;
                    }

                    if (!assignmentModalEl) {
                        console.error('assignmentModalEl is null!');
                        alert('Modal element not found. Please refresh the page.');
                        return false;
                    }

                    assignmentIdInput.value = '';
                    categoryIdInput.value = categoryId;
                    managerSelect.value = '';

                    const modalTitle = assignmentModalEl.querySelector('.modal-title');
                    if (modalTitle) modalTitle.textContent = 'Assign Manager';

                    // Show modal
                    console.log('Calling showModal()...');
                    const result = showModal();
                    console.log('showModal() returned:', result);

                    // Verify modal is visible
                    setTimeout(() => {
                        const ariaHidden = assignmentModalEl.getAttribute('aria-hidden');
                        const hasShow = assignmentModalEl.classList.contains('show');
                        const display = window.getComputedStyle(assignmentModalEl).display;

                        console.log('[Add] Modal state check:', {
                            ariaHidden: ariaHidden,
                            hasShow: hasShow,
                            display: display
                        });

                        if (ariaHidden === 'true' || !hasShow || display === 'none') {
                            console.warn('[Add] Modal not properly shown, fixing...');
                            assignmentModalEl.setAttribute('aria-hidden', 'false');
                            assignmentModalEl.classList.add('show');
                            assignmentModalEl.style.display = 'block';
                        }
                    }, 100);

                    return result;
                }

                // Function to open modal for editing assignment
                function openEditModal(assignmentId, managerId) {
                    console.log('=== openEditModal START ===');
                    console.log('assignmentId:', assignmentId, 'managerId:', managerId);
                    console.log('assignmentModalEl:', assignmentModalEl);
                    console.log('assignmentModal:', assignmentModal);

                    if (!assignmentId || !managerId) {
                        alert('Invalid assignment data.');
                        return false;
                    }

                    if (!assignmentModalEl) {
                        console.error('assignmentModalEl is null!');
                        alert('Modal element not found. Please refresh the page.');
                        return false;
                    }

                    assignmentIdInput.value = assignmentId;
                    categoryIdInput.value = '';

                    // Check if the manager exists in the dropdown (they might be filtered out as already assigned)
                    const existingOption = managerSelect.querySelector(`option[value="${managerId}"]`);
                    if (!existingOption) {
                        // Manager not in list (because they're already assigned), so add them temporarily
                        // Get manager name from the table row
                        const row = document.getElementById(`row-${assignmentId}`);
                        let managerName = 'Current Manager';
                        let managerEmail = '';
                        if (row) {
                            const nameElement = row.querySelector('.manager-name');
                            const emailElement = row.querySelector('.manager-email');
                            if (nameElement) managerName = nameElement.textContent.trim();
                            if (emailElement) managerEmail = emailElement.textContent.trim();
                        }

                        // Add the option
                        const option = document.createElement('option');
                        option.value = managerId;
                        option.textContent = managerEmail ? `${managerName} (${managerEmail})` : managerName;
                        option.setAttribute('data-current', 'true'); // Mark as current assignment
                        managerSelect.appendChild(option);
                    }

                    managerSelect.value = managerId;

                    const modalTitle = assignmentModalEl.querySelector('.modal-title');
                    if (modalTitle) modalTitle.textContent = 'Edit Assignment';

                    // Show modal
                    console.log('Calling showModal()...');
                    const result = showModal();
                    console.log('showModal() returned:', result);

                    // Verify modal is visible
                    setTimeout(() => {
                        const ariaHidden = assignmentModalEl.getAttribute('aria-hidden');
                        const hasShow = assignmentModalEl.classList.contains('show');
                        const display = window.getComputedStyle(assignmentModalEl).display;

                        console.log('[Edit] Modal state check:', {
                            ariaHidden: ariaHidden,
                            hasShow: hasShow,
                            display: display
                        });

                        if (ariaHidden === 'true' || !hasShow || display === 'none') {
                            console.warn('[Edit] Modal not properly shown, fixing...');
                            assignmentModalEl.setAttribute('aria-hidden', 'false');
                            assignmentModalEl.classList.add('show');
                            assignmentModalEl.style.display = 'block';
                        }
                    }, 100);

                    return result;
                }

                // Open modal for Add (from unassigned categories)
                const addButtons = document.querySelectorAll('.btn-add-assignment');
                console.log('Found', addButtons.length, 'Add buttons');
                addButtons.forEach((btn, index) => {
                    console.log(`Add button ${index}:`, btn, 'categoryId:', btn.dataset.categoryId);
                    btn.addEventListener('click', function (e) {
                        console.log('=== ADD BUTTON CLICKED ===');
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Button element:', this);
                        console.log('categoryId from dataset:', this.dataset.categoryId);
                        openAddModal(this.dataset.categoryId || '');
                    });
                });

                // Open modal for Edit
                const editButtons = document.querySelectorAll('.btn-edit-assignment');
                console.log('Found', editButtons.length, 'Edit buttons');
                editButtons.forEach((btn, index) => {
                    console.log(`Edit button ${index}:`, btn, 'assignmentId:', btn.dataset.id, 'managerId:', btn.dataset.managerId);
                    btn.addEventListener('click', function (e) {
                        console.log('=== EDIT BUTTON CLICKED ===');
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('Button element:', this);
                        console.log('assignmentId from dataset:', this.dataset.id);
                        console.log('managerId from dataset:', this.dataset.managerId);
                        openEditModal(this.dataset.id, this.dataset.managerId);
                    });
                });

                // Submit form (Add/Edit)
                assignmentForm.addEventListener('submit', function (e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const assignmentId = assignmentIdInput.value.trim();
                    const managerId = managerSelect.value;
                    const categoryId = categoryIdInput.value.trim();

                    // Validation
                    if (!managerId) {
                        alert('Please select a category manager.');
                        return;
                    }

                    // For create, category_id is required
                    if (!assignmentId && !categoryId) {
                        alert('Please select a category to assign.');
                        return;
                    }

                    const url = assignmentId
                        ? `/user-management/api/category_assignments/${assignmentId}/update/`
                        : '/user-management/api/category_assignments/create/';

                    const requestBody = assignmentId
                        ? { manager_id: managerId }
                        : { manager_id: managerId, category_id: categoryId };

                    // Disable submit button to prevent double submission
                    const submitBtn = assignmentForm.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Saving...';

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken
                        },
                        body: JSON.stringify(requestBody)
                    })
                        .then(res => {
                            if (!res.ok) {
                                return res.json().then(data => {
                                    throw new Error(data.error || `HTTP error! status: ${res.status}`);
                                });
                            }
                            return res.json();
                        })
                        .then(data => {
                            if (data.error) {
                                alert(data.error);
                                submitBtn.disabled = false;
                                submitBtn.textContent = originalText;
                                return;
                            }
                            // Close modal first, then reload
                            hideModal();
                            // Wait for modal to fully close before reload
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        })
                        .catch(err => {
                            console.error('Error:', err);
                            alert(err.message || 'An error occurred. Please try again.');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        });
                });

                // Delete assignment
                const assignmentsTable = document.querySelector('#assignments-table tbody');
                if (assignmentsTable) {
                    assignmentsTable.addEventListener('click', function (e) {
                        if (!e.target.closest('.btn-delete-assignment')) return;

                        e.preventDefault();
                        e.stopPropagation();

                        const btn = e.target.closest('.btn-delete-assignment');
                        const assignmentId = btn.dataset.id;

                        if (!assignmentId) {
                            alert('Invalid assignment ID.');
                            return;
                        }

                        if (!confirm('Are you sure you want to delete this assignment?')) return;

                        // Disable button to prevent double clicks
                        btn.disabled = true;
                        const originalText = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Deleting...';

                        fetch(`/user-management/api/category_assignments/${assignmentId}/delete/`, {
                            method: 'DELETE',
                            headers: { 'X-CSRFToken': csrftoken }
                        })
                            .then(res => {
                                if (!res.ok) {
                                    return res.json().then(data => {
                                        throw new Error(data.error || `HTTP error! status: ${res.status}`);
                                    });
                                }
                                return res.json();
                            })
                            .then(data => {
                                if (data.error) {
                                    alert(data.error);
                                    btn.disabled = false;
                                    btn.innerHTML = originalText;
                                    return;
                                }
                                // Reload page to show updated data
                                window.location.reload();
                            })
                            .catch(err => {
                                console.error('Error:', err);
                                alert(err.message || 'An error occurred. Please try again.');
                                btn.disabled = false;
                                btn.innerHTML = originalText;
                            });
                    });
                }

                // Handle Add button click for dynamically added unassigned categories
                const unassignedCategoriesGrid = document.getElementById('unassigned-categories-grid');
                if (unassignedCategoriesGrid) {
                    unassignedCategoriesGrid.addEventListener('click', function (e) {
                        if (!e.target.closest('.btn-add-assignment')) return;

                        e.preventDefault();
                        e.stopPropagation();

                        const btn = e.target.closest('.btn-add-assignment');
                        console.log('Unassigned category Add button clicked, categoryId:', btn.dataset.categoryId);
                        openAddModal(btn.dataset.categoryId || '');
                    });
                }

                // --- NEW: Unassigned Categories Filtering Logic ---
                const topicFilter = document.getElementById('topic-filter');
                const categorySearch = document.getElementById('category-search');

                function fetchAndRenderUnassignedCategories() {
                    const topicId = topicFilter.value;
                    const search = categorySearch.value.trim();

                    let url = '/user-management/api/unassigned_categories/';
                    const params = new URLSearchParams();
                    if (topicId) params.append('topic_id', topicId);
                    if (search) params.append('search', search);

                    if (params.toString()) {
                        url += '?' + params.toString();
                    }

                    unassignedCategoriesGrid.innerHTML = `
                        <div class="col-span-full flex justify-center py-8">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    `;

                    fetch(url)
                        .then(res => res.json())
                        .then(categories => {
                            if (categories.length === 0) {
                                unassignedCategoriesGrid.innerHTML = '<div class="col-span-1 text-gray-500">No categories match your filters.</div>';
                                return;
                            }

                            unassignedCategoriesGrid.innerHTML = categories.map(category => `
                                <div class="p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg border border-yellow-200 dark:border-yellow-800"
                                    id="unassigned-${category.id}">
                                    <div class="flex flex-col gap-1 mb-3">
                                        <div class="flex items-center justify-between">
                                            <h6 class="font-semibold text-yellow-900 dark:text-yellow-100 mb-0">${category.name_ENG}</h6>
                                            <span class="badge bg-warning badge-sm">${category.indicator_count} indicators</span>
                                        </div>
                                        <div class="text-xs text-yellow-700 dark:text-yellow-300">
                                            <i class="fas fa-folder-open mr-1"></i>${category.topic_name_eng}
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-warning btn-add-assignment"
                                        data-category-id="${category.id}">
                                        <i class="fas fa-plus mr-1"></i>Assign Manager
                                    </button>
                                </div>
                            `).join('');
                        })
                        .catch(err => {
                            console.error('Error fetching categories:', err);
                            unassignedCategoriesGrid.innerHTML = '<div class="col-span-1 text-danger">Failed to load categories.</div>';
                        });
                }

                if (topicFilter) {
                    topicFilter.addEventListener('change', fetchAndRenderUnassignedCategories);
                }

                if (categorySearch) {
                    let debounceTimer;
                    categorySearch.addEventListener('input', function () {
                        clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(fetchAndRenderUnassignedCategories, 300);
                    });
                }
            }); // End DOMContentLoaded
        })();
    </script>

</body>

</html>