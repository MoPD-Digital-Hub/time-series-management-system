{% extends 'base/base.html' %}
{% load static %}
{% block content %}
{% include 'base/common/nav.html' %}
{% include 'base/common/header.html' %}

<style>
html, body, .pc-container, .pc-content, .chat-container {
    height: 100%;
}

/* Full screen container */
.chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
}

/* Chat log */
#chat-log {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: #fff;
}

/* Messages */
.message {
    max-width: 75%;
    width: fit-content;
    padding: 10px 14px;
    border-radius: 16px;
    font-size: 0.95rem;
    line-height: 1.4;
    margin-bottom: 12px;
    word-wrap: break-word;
}

.user {
    background: #4680ff;
    color: #fff;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.ai {
    background: #f1f3f5;
    color: #000;
    margin-right: auto;
    border-bottom-left-radius: 4px;
}

/* Typing indicator */
.typing {
    display: flex;
    align-items: center;
    gap: 6px;
    font-style: italic;
    color: #555;
}

.dot {
    width: 6px;
    height: 6px;
    background: #555;
    border-radius: 50%;
    animation: blink 1.4s infinite both;
}

.dot:nth-child(2) { animation-delay: .2s; }
.dot:nth-child(3) { animation-delay: .4s; }

@keyframes blink {
    0% { opacity: .2; }
    20% { opacity: 1; }
    100% { opacity: .2; }
}

/* Footer */
.chat-footer {
    border-top: 1px solid #dee2e6;
    padding: 10px;
    background: #fff;
}

/* Chart sizing */
.ai canvas {
    margin-top: 10px;
    max-width: 100%;
    max-height: 300px;
}
</style>

<div class="pc-container chat-container">
    <div class="pc-content d-flex flex-column chat-container">

        <!-- Chat messages -->
        <div id="chat-log"></div>

        <!-- Input -->
        <div class="chat-footer">
            <div class="input-group">
                <input id="chat-message-input"
                       type="text"
                       class="form-control"
                       placeholder="Ask Admas AI..."
                       autocomplete="off">
                <button id="chat-message-submit" class="btn btn-primary">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </div>

    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const roomName = "295";
const socket = new WebSocket(
    "wss://" + "data-hub.mopd.gov.et" + "/ws/chat-web/" + roomName + "/"
);

let currentAiMessageElement = null;
let aiBuffer = "";
let typingIndicator = null;
const chatLog = document.getElementById("chat-log");

/* =========================
   WebSocket handling
========================= */
socket.onmessage = function(event) {
    const data = JSON.parse(event.data);

    // Chat history
    if (data.question && data.response) {
        appendUserMessage(data.question);
        appendAiMessage(data.response);
        return;
    }

    // Streaming response
    if (data.is_stream) {
        removeTyping();

        if (!currentAiMessageElement) {
            currentAiMessageElement = createAiBubble();
            aiBuffer = "";
        }

        aiBuffer += data.message;
        renderAiContent(currentAiMessageElement, aiBuffer);
        return;
    }

    // Final
    if (data.is_final) {
        removeTyping();
        currentAiMessageElement = null;
        aiBuffer = "";
    }
};

/* =========================
   Helpers
========================= */
function createAiBubble() {
    const div = document.createElement("div");
    div.className = "message ai";
    chatLog.appendChild(div);
    scrollBottom();
    return div;
}

function appendAiMessage(text) {
    const div = createAiBubble();
    renderAiContent(div, text);
}

function appendUserMessage(text) {
    const div = document.createElement("div");
    div.className = "message user";
    div.textContent = text;
    chatLog.appendChild(div);
    scrollBottom();
}

function showTyping() {
    if (typingIndicator) return;

    typingIndicator = document.createElement("div");
    typingIndicator.className = "message typing";
    typingIndicator.innerHTML = `
        <span>AI is thinking</span>
        <span class="dot"></span>
        <span class="dot"></span>
        <span class="dot"></span>
    `;
    chatLog.appendChild(typingIndicator);
    scrollBottom();
}

function removeTyping() {
    if (typingIndicator) {
        typingIndicator.remove();
        typingIndicator = null;
    }
}

function scrollBottom() {
    chatLog.scrollTop = chatLog.scrollHeight;
}

/* =========================
   Send message
========================= */
document.getElementById("chat-message-submit").onclick = sendMessage;
document.getElementById("chat-message-input").onkeydown = e => {
    if (e.key === "Enter") sendMessage();
};

function sendMessage() {
    const input = document.getElementById("chat-message-input");
    const message = input.value.trim();
    if (!message) return;

    socket.send(JSON.stringify({ message }));
    appendUserMessage(message);
    showTyping();
    input.value = "";
}

/* =========================
   AI content renderer
========================= */
function renderAiContent(container, text) {
    container.innerHTML = "";

    const jsonMatch = text.match(/\{[\s\S]*?\}/);

    if (jsonMatch) {
        try {
            const chartConfig = JSON.parse(jsonMatch[0]);
            const cleanText = text.replace(jsonMatch[0], "").trim();

            if (cleanText) {
                const p = document.createElement("p");
                p.innerHTML = cleanText;
                container.appendChild(p);
            }

            const canvas = document.createElement("canvas");
            container.appendChild(canvas);
            renderChart(canvas, chartConfig);
            scrollBottom();
            return;
        } catch (err) {
            console.error("Chart JSON error", err);
        }
    }

    container.innerHTML = text;
    scrollBottom();
}

function renderChart(canvas, cfg) {
    new Chart(canvas.getContext("2d"), {
        type: cfg.type || "bar",
        data: {
            labels: cfg.labels,
            datasets: [{
                label: cfg.label,
                data: cfg.data,
                backgroundColor: "#4680ff"
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

/* Auto-scroll */
new MutationObserver(scrollBottom)
    .observe(chatLog, { childList: true, subtree: true });
</script>

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
{% include 'base/common/js.html' %}
{% endblock %}
