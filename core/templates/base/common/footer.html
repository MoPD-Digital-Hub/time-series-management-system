{% load static %}
<style>
    #chat-log {
        height: 55vh; /* Perfect for modal */
        overflow-y: auto;
        padding: 15px;
        background: #ffffff;
    }

    .message {
        max-width: 75%;
        width: fit-content;      /* üëà key */

        padding: 10px 14px;
        border-radius: 16px;
        font-size: 0.95rem;
        line-height: 1.4;
        margin-bottom: 12px;
    }


    .user {
        background: #4680ff;
        color: #fff;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }

    .ai {
        background: #f1f3f5;
        color: #000;
        margin-right: auto;
        border-bottom-left-radius: 4px;
    }

    /* Extra spacing between turns */
    .user + .ai,
    .ai + .user {
        margin-top: 10px;
    }

    /* Tighter spacing for same speaker */
    .user + .user,
    .ai + .ai {
        margin-top: 4px;
    }

    .typing {
        background: #f1f3f5;
        color: #555;
        font-style: italic;
        display: flex;
        align-items: center;
        gap: 4px;
        margin-right: auto;
    }

    .dot {
        width: 6px;
        height: 6px;
        background: #555;
        border-radius: 50%;
        animation: blink 1.4s infinite both;
    }

    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }

    @keyframes blink {
        0% { opacity: .2; }
        20% { opacity: 1; }
        100% { opacity: .2; }
    }

  .chat-footer {
      border-top: 1px solid #dee2e6;
      padding: 10px;
      background: #fff;
  }
</style>



<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">


<footer class="pc-footer">
    <div class="footer-wrapper container-fluid mx-10">
        <div class="grid grid-cols-12 gap-1.5">
            <div class="col-span-12 sm:col-span-6 my-1">
                <p class="m-0">Dashboard crafted by Team MoPD<a href="https://themeforest.net/user/phoenixcoded"
                        class="text-theme-bodycolor dark:text-themedark-bodycolor hover:text-primary-500 dark:hover:text-primary-500"
                        target="_blank"></a></p>
            </div>
        </div>
    </div>
</footer>

<!-- AI Chat Modal -->
<div class="modal fade" id="aiModal" tabindex="-1" aria-labelledby="aiModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable" style="max-width: 80%;">
    <div class="modal-content" style="height: 82vh;">

      <!-- Modal Header -->
      <div class="modal-header">
        <h3 class="modal-title d-flex align-items-center" id="aiModalLabel">
          <i class="bi bi-robot me-2"></i> Admas AI
        </h3>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- Modal Body -->
      <div class="modal-body p-0" style="height: calc(100% - 70px);"> <!-- Adjust height to leave room for header/footer -->

        <div class="card border-0 rounded-0 h-100 d-flex flex-column">

          <!-- Messages -->
          <div id="chat-log" class="d-flex flex-column gap-2 flex-grow-1 overflow-auto px-3 py-2"></div>

          <!-- Input -->
          <div class="chat-footer">
            <div class="input-group">
              <input
                id="chat-message-input"
                type="text"
                class="form-control"
                placeholder="Ask Admas AI..."
                autocomplete="off"
              >
              <button id="chat-message-submit" class="btn btn-primary">
                <i class="bi bi-send"></i>
              </button>
            </div>
          </div>

        </div>

      </div>

    </div>
  </div>
</div>




<div class="floting-button">
    <div class="btn btn btn-danger d-inline-flex align-items-center gap-2 btn-ai" data-pc-toggle="modal" data-pc-target="#aiModal">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-robot" viewBox="0 0 16 16">
            <path d="M6 12.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 0 1h-3a.5.5 0 0 1-.5-.5M3 8.062C3 6.76 4.235 5.765 5.53 5.886a26.6 26.6 0 0 0 4.94 0C11.765 5.765 13 6.76 13 8.062v1.157a.93.93 0 0 1-.765.935c-.845.147-2.34.346-4.235.346s-3.39-.2-4.235-.346A.93.93 0 0 1 3 9.219zm4.542-.827a.25.25 0 0 0-.217.068l-.92.9a25 25 0 0 1-1.871-.183.25.25 0 0 0-.068.495c.55.076 1.232.149 2.02.193a.25.25 0 0 0 .189-.071l.754-.736.847 1.71a.25.25 0 0 0 .404.062l.932-.97a25 25 0 0 0 1.922-.188.25.25 0 0 0-.068-.495c-.538.074-1.207.145-1.98.189a.25.25 0 0 0-.166.076l-.754.785-.842-1.7a.25.25 0 0 0-.182-.135"/>
            <path d="M8.5 1.866a1 1 0 1 0-1 0V3h-2A4.5 4.5 0 0 0 1 7.5V8a1 1 0 0 0-1 1v2a1 1 0 0 0 1 1v1a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-1a1 1 0 0 0 1-1V9a1 1 0 0 0-1-1v-.5A4.5 4.5 0 0 0 10.5 3h-2zM14 7.5V13a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V7.5A3.5 3.5 0 0 1 5.5 4h5A3.5 3.5 0 0 1 14 7.5"/>
        </svg>
        <span>          
        </span>
    </div>
</div>

<script>
    const roomName = "295";
    const socket = new WebSocket(
        "wss://" + "data-hub.mopd.gov.et" + "/ws/chat-web/" + roomName + "/"
    );

    let currentAiMessageElement = null;
    let aiBuffer = "";
    let typingIndicator = null;

    const chatLog = document.getElementById("chat-log");

    // ========================
    // WebSocket message handling
    // ========================
    socket.onmessage = function(event) {
        const data = JSON.parse(event.data);

        // 1Ô∏è‚É£ Chat history
        if (data.question && data.response) {
            appendUserMessage(data.question);
            appendAiMessage(data.response);
            scrollBottom();
            return;
        }

        // 2Ô∏è‚É£ Streaming AI response
        if (data.is_stream) {
            removeTyping();

            if (!currentAiMessageElement) {
                currentAiMessageElement = createAiBubble();
                aiBuffer = "";
            }

            aiBuffer += data.message;
            currentAiMessageElement.innerHTML = aiBuffer;
            scrollBottom();
            return;
        }

        // 3Ô∏è‚É£ Final signal
        if (data.is_final) {
            removeTyping();
            currentAiMessageElement = null;
            aiBuffer = "";
            scrollBottom();
        }
    };

    // ========================
    // Helper functions
    // ========================
    function createAiBubble() {
        const div = document.createElement("div");
        div.className = "message ai";
        chatLog.appendChild(div);
        scrollBottom();
        return div;
    }

    function appendAiMessage(html) {
        const div = createAiBubble();
        div.innerHTML = html;
        scrollBottom();
    }

    function appendUserMessage(text) {
        const div = document.createElement("div");
        div.className = "message user";
        div.textContent = text;
        chatLog.appendChild(div);
        scrollBottom();
    }

    function showTyping() {
        if (typingIndicator) return;

        typingIndicator = document.createElement("div");
        typingIndicator.className = "message typing";
        typingIndicator.innerHTML = `
            <span>AI is typing</span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        `;
        chatLog.appendChild(typingIndicator);
        scrollBottom();
    }

    function removeTyping() {
        if (typingIndicator) {
            typingIndicator.remove();
            typingIndicator = null;
            scrollBottom();
        }
    }

    // ========================
    // Scroll helper
    // ========================
    function scrollBottom() {
        // Always scroll to bottom
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    // ========================
    // Send message
    // ========================
    document.getElementById("chat-message-submit").onclick = sendMessage;
    document.getElementById("chat-message-input").onkeydown = function(e) {
        if (e.key === "Enter") sendMessage();
    };

    function sendMessage() {
        const input = document.getElementById("chat-message-input");
        const message = input.value.trim();
        if (!message) return;

        socket.send(JSON.stringify({ message }));
        appendUserMessage(message);
        showTyping();
        input.value = "";
        scrollBottom();
    }

    // ========================
    // Auto-scroll observer (bonus)
    // Ensures scroll if messages added dynamically from other sources
    // ========================
    const observer = new MutationObserver(scrollBottom);
    observer.observe(chatLog, { childList: true, subtree: true });
</script>


