{% load static %}

<!doctype html>
<html lang="en" class="preset-1" data-pc-sidebar-caption="true" data-pc-layout="vertical" data-pc-direction="ltr" dir="ltr">
<head>
    <title>Climate Dashboard | TSMS</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,minimal-ui">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    
    <!-- Fonts -->
    <link rel="stylesheet" href="{% static 'assets/fonts/inter/inter.css' %}">
    <link rel="stylesheet" href="{% static 'assets/fonts/phosphor/duotone/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/fonts/tabler-icons.min.css' %}">
    <link rel="stylesheet" href="{% static 'assets/fonts/feather.css' %}">
    <link rel="stylesheet" href="{% static 'assets/fonts/fontawesome.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/landing-modern.css' %}">

    <!-- jQuery (if needed for your custom scripts) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- CKEditor 5 CDN -->
    <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>


    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Your CSS -->
    <link rel="stylesheet" href="{% static 'assets/css/style.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/landing-modern.css' %}">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    
</head>

<body>
    {% include "base/common/climate_sidebar.html" %}

    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Resource</h5>
                    <button class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'add_resource' %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="title_ENG" class="form-label">Title (ENG)</label>
                            <input type="text" name="title_ENG" id="title_ENG" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="title_AMH" class="form-label">Title (AMH)</label>
                            <input type="text" name="title_AMH" id="title_AMH" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label for="document_category" class="form-label">Category</label>
                            <select name="document_category" id="document_category" class="form-select" required>
                                <option value="">Select Category</option>
                                {% for cat in document_categories %}
                                <option value="{{ cat.id }}">{{ cat.name_ENG }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="file_type" class="form-label">File Type</label>
                            <select name="file_type" id="file_type" class="form-select" required>
                                <option value="">Select Type</option>
                                <option value="document">Document</option>
                                <option value="video">Video</option>
                                <option value="audio">Audio</option>
                                <option value="image">Image</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="file" class="form-label">Upload File</label>
                            <input type="file" name="file" id="file" class="form-control" required>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn-primary">Add Resource</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Article</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'add_content' %}">
                    {% csrf_token %}
                    <div class="modal-body">

                        <!-- Title (ENG) -->
                        <div class="mb-3">
                            <label for="title_ENG" class="form-label">Title (ENG)</label>
                            <input type="text" name="title_ENG" id="title_ENG" class="form-control" required>
                        </div>

                        <!-- Title (AMH) -->
                        <div class="mb-3">
                            <label for="title_AMH" class="form-label">Title (AMH)</label>
                            <input type="text" name="title_AMH" id="title_AMH" class="form-control">
                        </div>

                     

                        <!-- Document Category -->
                        <div class="mb-3">
                            <label for="document_category" class="form-label">Category</label>
                            <select name="document_category" id="document_category" class="form-select">
                                <option value="">Select Category</option>
                                {% for cat in document_categories %}
                                    <option value="{{ cat.id }}">{{ cat.name_ENG }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Body (Rich Text) -->
                            <div class="mb-3">
                                <label for="body" class="form-label">Article Body</label>
                                <textarea name="body" id="body" class="form-control" rows="20"></textarea>
                            </div>
                      
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Article</button>
                    </div>
                </form>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <main class="climate-main-content">
        <!-- Header -->
        <div class="content-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin: 0; font-size: 1.75rem; font-weight: 700; color: #1e293b;">
                        {{ climate_topic.title_ENG }} Management
                    </h1>
                    <p style="margin: 0.5rem 0 0; color: #64748b;">
                        {{ climate_topic.description|default:"Comprehensive analytics and knowledge management for climate-related data, policies, and initiatives." }}
                    </p>
                </div>
               <div class="row">
                    <div class="col-6 d-grid">
                        <button type="button"
                            class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2"
                            data-pc-toggle="modal"
                            data-pc-target="#uploadModal">
                            <i class="fas fa-upload"></i>
                            Upload Document
                        </button>
                    </div>

                    <div class="col-6 d-grid">
                        <button type="button"
                            class="btn btn-primary w-100 d-flex align-items-center justify-content-center gap-2"
                            data-pc-toggle="modal"
                            data-pc-target="#createModal">
                            <i class="fas fa-pen"></i>
                            Create Article
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <!-- Content Body -->
        <div class="content-body">
           
            <!-- Documents Tab -->
            <div>
                <!-- Search -->
                <div class="content-card">
                    <div class="card-title">
                        <i class="fas fa-search"></i>
                        Search Resource
                    </div>
                    <div>
                        <input type="text" class="search-input" id="document-search-input" placeholder="Search by title, category...">
                    </div>
                </div>

                <!-- Document Category Tabs -->
                <div class="content-card">
                    <div class="card-title">
                        <i class="fas fa-folder"></i>
                        Resource Categories
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1rem;">
                        <button class="filter-btn document-category-tab active" data-category-id="" style="position: relative;">
                            All Resources
                            <span style="margin-left: 0.5rem; padding: 0.125rem 0.5rem; background: rgba(59,130,246,0.2); border-radius: 12px; font-size: 0.75rem;" id="all-docs-count">{{ documents.count }}</span>
                        </button>
                        {% for doc_category in document_categories %}
                        <button class="filter-btn document-category-tab" data-category-id="{{ doc_category.id }}" style="position: relative;">
                            {{ doc_category.name_ENG }}
                            <span style="margin-left: 0.5rem; padding: 0.125rem 0.5rem; background: rgba(59,130,246,0.2); border-radius: 12px; font-size: 0.75rem;" class="doc-category-count" data-category="{{ doc_category.id }}">0</span>
                        </button>
                        {% endfor %}
                    </div>

                    <!-- File Type Tabs -->
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; border-bottom: 2px solid #e2e8f0; padding-bottom: 1rem; margin-bottom: 1.5rem;">
                        <button class="filter-btn file-type-tab active" data-file-type="">
                            <i class="fas fa-layer-group" style="margin-right: 0.25rem;"></i> All Types
                        </button>
                        <button class="filter-btn file-type-tab" data-file-type="document">
                            <i class="fas fa-file-alt" style="margin-right: 0.25rem;"></i> Document
                        </button>
                        <button class="filter-btn file-type-tab" data-file-type="video">
                            <i class="fas fa-video" style="margin-right: 0.25rem;"></i> Video
                        </button>
                        <button class="filter-btn file-type-tab" data-file-type="audio">
                            <i class="fas fa-volume-up" style="margin-right: 0.25rem;"></i> Audio
                        </button>
                        <button class="filter-btn file-type-tab" data-file-type="image">
                            <i class="fas fa-image" style="margin-right: 0.25rem;"></i> Image
                        </button>
                        <button class="filter-btn file-type-tab" data-file-type="other">
                            <i class="fas fa-ellipsis-h" style="margin-right: 0.25rem;"></i> Other
                        </button>
                    </div>


                    <!-- Documents List -->
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3 style="margin: 0; font-size: 1.125rem; font-weight: 600; color: #1e293b;">
                                Resource Library
                            </h3>
                            <span style="padding: 0.25rem 0.75rem; background: rgba(59,130,246,0.1); color: #3b82f6; border-radius: 20px; font-size: 0.875rem; font-weight: 600;" id="document-count">{{ documents.count }}</span>
                        </div>
                        <div id="documents-container">
                           <div class="row g-4">
                                {% for document in documents %}
                                <div class="col-3 col-sm-3 col-md-3 col-lg-3">
                                    <div class="document-item h-100" 
                                         data-category-id="{{ document.document_category.id|default:'' }}"
                                         data-file-type="{{ document.file_type }}">
                                        <div style="display: flex; flex-direction: column; height: 100%; justify-content: space-between;">
                                            <div>
                                                <h4 style="margin: 0 0 0.5rem; font-size: 1rem; font-weight: 600; color: #1e293b;">
                                                    {% if document.file_type == 'video' %}
                                                        <i class="fas fa-video text-purple" style="margin-right:0.5rem;"></i>
                                                    {% elif document.file_type == 'audio' %}
                                                        <i class="fas fa-volume-up text-green" style="margin-right:0.5rem;"></i>
                                                    {% elif document.file_type == 'image' %}
                                                        <i class="fas fa-image text-blue" style="margin-right:0.5rem;"></i>
                                                    {% else %}
                                                        <i class="fas fa-file-pdf text-danger" style="margin-right:0.5rem;"></i>
                                                    {% endif %}
                                                    {{ document.title_ENG }}
                                                </h4>

                                                {% if document.title_AMH %}
                                                <p style="margin: 0 0 0.5rem; color: #64748b; font-size: 0.875rem;">
                                                    {{ document.title_AMH }}
                                                </p>
                                                {% endif %}

                                                {% if document.document_category %}
                                                <span class="category-badge badge-primary">
                                                    {{ document.document_category.name_ENG }}
                                                </span>
                                                {% endif %}
                                            </div>

                                            <a href="{{ document.file.url }}" target="_blank" class="btn-primary mt-3" style="text-decoration: none;">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                {% empty %}
                                <div class="col-6 text-center py-5" style="color: #94a3b8;">
                                    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                    <p>No Resource found. Documents will appear here once uploaded.</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Published Contents Grid -->
            <div class="content-card mt-4">
                <div class="card-title">
                    <i class="fas fa-file-alt"></i>
                    Published Contents
                </div>

                {% if contents %}
                <div class="content-grid row g-4">
                {% for content in contents %}
                <div class="col-12 col-sm-6 col-md-3">
                    <div class="content-card border rounded p-3 h-100 d-flex flex-column justify-content-between" 
                        style="background: #f9fafb; overflow: hidden;">
                        
                        <div>
                            <h5 class="mb-2" style="font-weight: 600; color: #1e293b; font-size: 1rem;">
                                {{ content.title_ENG }}
                            </h5>

                            {% if content.title_AMH %}
                            <p style="color: #64748b; font-size: 0.75rem; margin-bottom: 0.5rem;">
                                {{ content.title_AMH }}
                            </p>
                            {% endif %}

                            {% if content.document_category %}
                            <span class="badge bg-primary mb-2">{{ content.document_category.name_ENG }}</span>
                            {% endif %}

                            <!-- Rich text body preview -->
                            <div class="content-body-preview" style="max-height: 200px; overflow-y: auto; font-size: 0.85rem; color: #334155;">
                                {{ content.body|safe }}
                            </div>

                            
                        </div>

                        <div class="mt-2 text-end">
                            <small class="text-muted">{{ content.created_at|date:"M d, Y" }}</small>
                        </div>
                    </div>
                </div>
                {% endfor %}
                </div>

                {% else %}
                <div class="text-center py-5" style="color: #94a3b8;">
                    <i class="fas fa-file-alt" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                    <p>No published contents yet. Once added, they will appear here.</p>
                </div>
                {% endif %}
            </div>


        </div>
    </main>

    {% include 'usermanagement/common/js.html' %}

    <script>
        // Filters
        let currentDocumentCategory = '';
        let currentFileType = '';

        function filterDocuments() {
            const searchQuery = document.getElementById('document-search-input').value.toLowerCase();
            const documents = document.querySelectorAll('.document-item');
            let visibleCount = 0;

            // Count per category
            const categoryCounts = {};
            documents.forEach(doc => {
                const docCategoryId = doc.dataset.categoryId || '';
                if (!categoryCounts[docCategoryId]) categoryCounts[docCategoryId] = 0;
                categoryCounts[docCategoryId]++;
            });

            document.querySelectorAll('.doc-category-count').forEach(countEl => {
                const catId = countEl.dataset.category;
                countEl.textContent = categoryCounts[catId] || 0;
            });

            documents.forEach(doc => {
                const docCategoryId = doc.dataset.categoryId || '';
                const docFileType = doc.dataset.fileType || '';
                const docTitle = doc.textContent.toLowerCase();

                const matchesSearch = !searchQuery || docTitle.includes(searchQuery);
                const matchesCategory = !currentDocumentCategory || docCategoryId === currentDocumentCategory;
                const matchesFileType = !currentFileType || docFileType === currentFileType;

                if (matchesSearch && matchesCategory && matchesFileType) {
                    doc.style.display = '';
                    visibleCount++;
                } else {
                    doc.style.display = 'none';
                }
            });

            document.getElementById('document-count').textContent = visibleCount;
            document.getElementById('all-docs-count').textContent = documents.length;
        }

        // Document Category Tabs
        document.querySelectorAll('.document-category-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.document-category-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentDocumentCategory = this.dataset.categoryId || '';
                filterDocuments();
            });
        });

        // File Type Tabs
        document.querySelectorAll('.file-type-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                document.querySelectorAll('.file-type-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                currentFileType = this.dataset.fileType || '';
                filterDocuments();
            });
        });

        // Search input
        document.getElementById('document-search-input').addEventListener('input', filterDocuments);

        // Initialize counts
        document.addEventListener('DOMContentLoaded', filterDocuments);

    document.addEventListener("DOMContentLoaded", function() {
        ClassicEditor
            .create(document.querySelector('#body'))
            .catch(error => {
                console.error(error);
            });
    });
</script>

</body>
</html>
