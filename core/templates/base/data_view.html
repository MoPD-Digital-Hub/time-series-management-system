{% extends 'base/base.html' %}
<title>{{ category.title_eng|default:'base' }}</title>
{% load static %}
{% block content %}
{% include 'base/common/nav.html' %}
{% include 'base/common/header.html' %}
<style>
    .table-responsive {
        max-height: 80vh;
        overflow-x: auto;
        overflow-y: auto;
    }

    #data-table thead th {
        position: sticky;
        top: 0;
        z-index: 5;
        background: #f8f9fa;
        white-space: nowrap;
    }

    .sticky-col {
        position: sticky;
        left: 0;
        background: white !important;
        z-index: 6;
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.05);
        min-width: 200px;
    }

    #data-table thead th.sticky-col {
        z-index: 7;
    }

    .value-cell {
        min-width: 100px;
        text-align: center;
    }

    .value-head {
        min-width: 100px;
        padding: 10px 5px !important;
        font-size: 11px;
        text-align: center;
    }

    .filter-section {
        position: relative;
        z-index: 200;
        /* Higher than table and sticky headers */
    }

    .card-body {
        overflow: visible !important;
    }
</style>
<div class="pc-container">
    <div class="pc-content">
        <div class="flex items-center justify-between mb-6">
            <h2 class="text-2xl font-bold"></h2>
        </div>

        <div class="card">
            <div class="card-body">
                <div class="flex items-center justify-between mb-4">
                    <h5 class="mb-0 font-bold text-lg">{{ category.name_ENG|default:'Category Data' }}</h5>
                    <div class="flex items-center gap-2">
                        <button id="clear-all"
                            class="px-3 py-1 rounded border border-theme-border text-gray-700 hover:bg-gray-50 text-sm">Clear</button>
                        <button id="apply-selection" class="btn btn-primary btn-sm">Apply</button>
                    </div>
                </div>


                <div class="mb-2 flex flex-row gap-6 items-start filter-section">
                    <!-- Frequency Dropdown -->
                    <div class="relative flex-1 min-w-[220px]">
                        <button type="button" id="dd-freq-btn"
                            class="w-full justify-between px-3 py-2 rounded border border-theme-border bg-white shadow-sm hover:bg-gray-50 inline-flex items-center gap-2">
                            <i class="fas fa-clock text-indigo-500"></i><span>Frequency</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="dd-freq"
                            class="hidden absolute z-[100] mt-2 dropdown-panel bg-white border border-theme-border rounded shadow-lg"
                            style="min-width: 100%; width: max-content;">
                            <div class="p-2 border-b">
                                <div id="freq-list" class="p-2 space-y-1">
                                    <form id="freq-form">
                                        <label class="block mb-2"><input type="radio" name="frequency" value="month">
                                            Monthly</label>
                                        <label class="block mb-2"><input type="radio" name="frequency" value="quarter">
                                            Quarterly</label>
                                        <label class="block mb-2"><input type="radio" name="frequency" value="annual">
                                            Annual</label>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicators Dropdown -->
                    <div class="relative flex-1 min-w-[220px]">
                        <button type="button" id="dd-ind-btn"
                            class="w-full justify-between px-3 py-2 rounded border border-theme-border bg-white shadow-sm hover:bg-gray-50 inline-flex items-center gap-2">
                            <i class="fas fa-chart-line text-success-500"></i><span>Indicators</span>
                            <i class="fas fa-chevron-down text-xs"></i>
                        </button>
                        <div id="dd-ind"
                            class="hidden absolute z-[100] mt-2 dropdown-panel bg-white border border-theme-border rounded shadow-lg"
                            style="min-width: 100%; width: max-content;">
                            <div class="p-2 border-b">
                                <div class="p-2 flex items-center justify-between">
                                    <label><input type="checkbox" id="select-all-ind"> Select All</label>
                                </div>
                                <div id="ind-list" class="p-2 space-y-1">
                                    {% for indicator in indicators %}
                                    <label class="block mb-2">
                                        <input type="checkbox" class="ind-checkbox" value="{{ indicator.id }}"
                                            data-id="{{ indicator.id }}" data-code="{{ indicator.code }}"
                                            data-title="{{ indicator.title_ENG }}"
                                            data-has-annual="{{ indicator.has_annual|yesno:'true,false' }}"
                                            data-has-quarterly="{{ indicator.has_quarterly|yesno:'true,false' }}"
                                            data-has-monthly="{{ indicator.has_monthly|yesno:'true,false' }}">
                                        {{ indicator.title_ENG }}
                                    </label>
                                    {% empty %}
                                    <span class="text-gray-400">No indicators available</span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="text-xs text-gray-500">Tip: make sure to select frequency first, then indicators</div>
            </div>

            <div class="table-responsive">
                <table id="data-table" class="table table-striped table-hover align-middle mb-0">
                    <thead id="data-table-head" class="table-light">
                        <!-- Will be populated by JS -->
                        <tr>
                            <th scope="col"
                                style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: left; vertical-align: bottom;">
                                Code</th>
                            {% for dp in datapoints %}
                            <th class="value-cell"
                                style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: left; vertical-align: bottom; white-space: nowrap;">
                                {{ dp.year_ec }} EC
                            </th>
                            {% endfor %}
                            <th scope="col"
                                style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: left; vertical-align: bottom;">
                                Topic</th>
                            <th scope="col"
                                style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: left; vertical-align: bottom;">
                                Category</th>
                            <th scope="col"
                                style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: left; vertical-align: bottom;">
                                Unit</th>
                            <th scope="col"
                                style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: left; vertical-align: bottom;">
                                Freq</th>
                            <th scope="col"
                                style="writing-mode: vertical-rl; transform: rotate(180deg); text-align: left; vertical-align: bottom;">
                                Desc</th>
                        </tr>
                    </thead>

                    <tbody id="data-table-body">
                        {% for row in table_rows %}
                        <tr data-id="{{ row.indicator.id }}" data-code="{{ row.indicator.code }}"
                            data-frequency="{{ row.indicator.frequency|default:'' }}">
                            <td>
                                <div class="font-bold">{{ row.indicator.code }}</div>
                                <div class="text-xs text-gray-700 truncate">{{ row.indicator.title_ENG }}</div>
                            </td>
                            {% for val in row.values %}
                            <td class="value-cell">{{ val|default:"-" }}</td>
                            {% endfor %}
                            <td class="text-xs">{{ category.topic.title_ENG }}</td>
                            <td class="text-xs">{{ category.name_ENG }}</td>
                            <td class="text-xs">-</td>
                            <td class="text-xs">-</td>
                            <td class="text-xs">-</td>
                        </tr>
                        {% endfor %}
                    </tbody>

                </table>
            </div>
        </div>
    </div>
    <input type="hidden" id="cat-id" value="{{ category.id }}">

    {% include 'base/common/footer.html' %}
    {% include 'base/common/js.html' %}
    <script src="{% static 'assets/js/data_view.js' %}"></script>

    {% endblock %}